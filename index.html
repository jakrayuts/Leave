<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>แบบฟอร์มขอลา ของนักศึกษาฝึกงาน</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">

  <div class="container py-5">
    <div class="card shadow-sm mx-auto" style="max-width: 600px;">
      <div class="card-body">
        <h2 class="card-title text-center mb-4">แบบฟอร์มขอลา</h2>

        <form id="leaveForm" novalidate>
          <div class="mb-3">
            <label for="nameSelect" class="form-label fw-bold">ชื่อ:</label>
            <select
              class="form-select"
              id="nameSelect"
              name="name"
              required
            >
              <option value="">-- เลือกชื่อพนักงาน --</option>
            </select>
            <div class="invalid-feedback">กรุณาเลือกชื่อพนักงาน</div>
          </div>

          <div class="mb-3">
            <label for="departmentBox" class="form-label fw-bold">แผนก:</label>
            <input
              type="text"
              id="departmentBox"
              name="department"
              class="form-control"
              readonly
            />
          </div>

          <div class="mb-3">
            <label for="typeSelect" class="form-label fw-bold">ประเภทการลา:</label>
            <select
              class="form-select"
              id="typeSelect"
              name="type"
              required
            >
              <option value="">-- เลือกประเภทการลา --</option>
              <option value="ลากิจ">ลากิจ</option>
              <option value="ลาป่วย">ลาป่วย</option>
              <option value="ลาพักร้อน">ลาพักร้อน</option>
            </select>
            <div class="invalid-feedback">กรุณาเลือกประเภทการลา</div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="dateStart" class="form-label fw-bold">วันที่เริ่มลา:</label>
              <input
                type="date"
                class="form-control"
                id="dateStart"
                name="dateStart"
                required
              />
              <div class="invalid-feedback">กรุณาระบุวันที่เริ่มลา</div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="timeStart" class="form-label fw-bold">เวลาเริ่มลา:</label>
              <input
                type="time"
                class="form-control"
                id="timeStart"
                name="timeStart"
              />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="dateEnd" class="form-label fw-bold">วันที่สิ้นสุด:</label>
              <input
                type="date"
                class="form-control"
                id="dateEnd"
                name="dateEnd"
                required
              />
              <div class="invalid-feedback">กรุณาระบุวันที่สิ้นสุด</div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="timeEnd" class="form-label fw-bold">เวลาสิ้นสุด:</label>
              <input
                type="time"
                class="form-control"
                id="timeEnd"
                name="timeEnd"
              />
            </div>
          </div>

          <div class="mb-3">
            <label for="leaveOfNumber" class="form-label fw-bold"
              >จำนวนวันที่ลา (เช่น 0.5, 1, 2):</label
            >
            <input
              type="number"
              step="0.5"
              class="form-control"
              id="leaveOfNumber"
              name="leaveOfNumber"
              required
              min="0.5"
            />
            <div class="invalid-feedback">กรุณาระบุจำนวนวันที่ลาอย่างถูกต้อง</div>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            ส่งคำขอลา
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS + Popper -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    const scriptURL =
      "https://script.google.com/macros/s/AKfycbx08ctWhjYOPsL8_bFHBhpJsiTMuD79_4Rxru47p8o20IEr14opXNwRd4iytXk7URtP/exec";
    let employeeList = [];

    // โหลดรายชื่อและแผนก
    fetch(scriptURL)
      .then((res) => res.json())
      .then((data) => {
        employeeList = data;
        const select = document.getElementById("nameSelect");
        data.forEach((emp) => {
          const option = document.createElement("option");
          option.value = emp.name;
          option.textContent = emp.name;
          select.appendChild(option);
        });
      })
      .catch((err) => {
        console.error("โหลดข้อมูลพนักงานล้มเหลว:", err);
      });

    // เมื่อเลือกชื่อ → แสดงแผนก
    document.getElementById("nameSelect").addEventListener("change", function () {
      const selectedName = this.value;
      const emp = employeeList.find((e) => e.name === selectedName);
      document.getElementById("departmentBox").value = emp ? emp.department : "";
    });

    // Bootstrap form validation
    (function () {
      "use strict";
      const form = document.getElementById("leaveForm");
      form.addEventListener(
        "submit",
        function (event) {
          event.preventDefault();
          event.stopPropagation();

          if (!form.checkValidity()) {
            form.classList.add("was-validated");
            return;
          }

          const data = Object.fromEntries(new FormData(form).entries());

          fetch(scriptURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((res) => res.json())
            .then((res) => {
              alert("ส่งคำขอลาสำเร็จ!");
              form.reset();
              document.getElementById("departmentBox").value = "";
              form.classList.remove("was-validated");
            })
            .catch((err) => {
              alert("เกิดข้อผิดพลาด: " + err);
              console.error(err);
            });
        },
        false
      );
    })();
  </script>
</body>
</html>
